#!/bin/bash

# Script: kubctl-0x01
# Purpose: Scale Django app deployment, verify scaling, perform load testing, and monitor resource usage.

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"

echo "üöÄ Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE
echo "‚úÖ Scale command executed."

echo "‚è≥ Waiting for pods to become ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

echo "üì¶ Current pods status:"
kubectl get pods -l app=messaging-app -n $NAMESPACE

# Get the NodePort for external access
NODE_PORT=$(kubectl get svc $SERVICE_NAME -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}')
MINIKUBE_IP=$(minikube ip)

APP_URL="http://$MINIKUBE_IP:$NODE_PORT"

echo "üåê Application should be accessible at: $APP_URL"

echo "üî• Performing load testing using wrk..."
echo "Note: Make sure 'wrk' is installed (brew install wrk)"
wrk -t4 -c50 -d20s $APP_URL/ || echo "wrk not installed or app not reachable."

echo "üìä Monitoring resource usage:"
kubectl top pods -n $NAMESPACE

echo "‚úÖ All done! Django app scaled, tested, and resource usage displayed."